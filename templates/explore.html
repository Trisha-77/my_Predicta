{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">

  <h2 class="mb-3 text-center text-primary">üìä Explore PLFS Data</h2>

  <!-- Filters Card -->
  <div class="card shadow-lg mb-4">
    <div class="card-header bg-primary text-white">
      <strong>Filters</strong>
    </div>
    <div class="card-body">
      <form method="POST" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">State</label>
          <select name="state" class="form-select">
            <option value="">-- Any --</option>
            {% for s in states %}
              <option value="{{s}}" {% if filters.state == s %}selected{% endif %}>{{s}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Gender</label>
          <select name="gender" class="form-select">
            <option value="">-- Any --</option>
            {% for g in genders %}
              <option value="{{g}}" {% if filters.gender == g %}selected{% endif %}>{{g}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Employment Status</label>
          <select name="employment_status" class="form-select">
            <option value="">-- Any --</option>
            {% for e in emp_status %}
              <option value="{{e}}" {% if filters.employment_status == e %}selected{% endif %}>{{e}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Year</label>
          <select name="year" class="form-select">
            <option value="">-- Any --</option>
            {% for y in years %}
              <option value="{{y}}" {% if filters.year == y %}selected{% endif %}>{{y}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Chart Type</label>
          <select name="chart_type" class="form-select">
            <option value="bar" {% if filters.chart_type == "bar" %}selected{% endif %}>Bar</option>
            <option value="line" {% if filters.chart_type == "line" %}selected{% endif %}>Line</option>
            <option value="pie" {% if filters.chart_type == "pie" %}selected{% endif %}>Pie</option>
          </select>
        </div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success px-4">üîç Search</button>
        </div>
      </form>
    </div>
  </div>

  {% if results %}
  <!-- Results Card -->
  <div class="card shadow-lg">
    <div class="card-header bg-success text-white d-flex justify-content-between">
      <span><strong>Results ({{ results|length }} rows)</strong></span>
      <div>
        <button id="downloadBtn" class="btn btn-light btn-sm">‚¨á Chart</button>

        <form action="/download_csv" method="POST" class="d-inline">
          <input type="hidden" name="state" value="{{ filters.state }}">
          <input type="hidden" name="gender" value="{{ filters.gender }}">
          <input type="hidden" name="employment_status" value="{{ filters.employment_status }}">
          <input type="hidden" name="year" value="{{ filters.year }}">
          <button type="submit" class="btn btn-light btn-sm">‚¨á CSV</button>
        </form>

        <form action="/download_excel" method="POST" class="d-inline">
          <input type="hidden" name="state" value="{{ filters.state }}">
          <input type="hidden" name="gender" value="{{ filters.gender }}">
          <input type="hidden" name="employment_status" value="{{ filters.employment_status }}">
          <input type="hidden" name="year" value="{{ filters.year }}">
          <button type="submit" class="btn btn-light btn-sm">‚¨á Excel</button>
        </form>
      </div>
    </div>
    <div class="card-body">

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="resultTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table" type="button" role="tab">üìã Table</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab">üìä Chart</button>
        </li>
      </ul>

      <div class="tab-content mt-3">
        <!-- Table Tab -->
        <div class="tab-pane fade show active" id="table" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-striped table-bordered text-center">
              <thead class="table-dark">
                <tr>
                  {% for key in results[0].keys() %}
                    <th>{{ key }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in results %}
                  <tr>
                    {% for val in row.values() %}
                      <td>{{ val }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Chart Tab -->
        <div class="tab-pane fade" id="chart" role="tabpanel">
          <div class="d-flex justify-content-center">
            <canvas id="myChart" style="max-width:600px; max-height:400px;"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js Script -->
  <script>
    const results = {{ results | tojson }};
    const chartType = "{{ filters.chart_type }}";

    const labels = results.map(r => r.age);
    const dataVals = results.map(r => parseFloat(r.wage) || 0);

    const ctx = document.getElementById("myChart");
    const myChart = new Chart(ctx, {
      type: chartType,
      data: {
        labels: labels,
        datasets: [{
          label: 'Wage by Age',
          data: dataVals,
          backgroundColor: [
            'rgba(54, 162, 235, 0.6)',
            'rgba(255, 99, 132, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(255, 206, 86, 0.6)'
          ],
          borderColor: 'rgba(0,0,0,0.2)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true },
        }
      }
    });

    document.getElementById("downloadBtn").addEventListener("click", function() {
      const link = document.createElement('a');
      link.href = myChart.toBase64Image();
      link.download = 'chart.png';
      link.click();
    });
  </script>

  <!-- {% elif filters %}
    <p class="text-danger text-center">‚ö† No results or suppressed for privacy.</p>
  {% endif %} -->
</div>
{% endblock %}
